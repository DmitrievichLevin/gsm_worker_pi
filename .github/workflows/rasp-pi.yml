name: Deploy to Raspberry Pi Zero Worker

# Controls when the workflow will run
on:
  push:
    branches: [prod]
env:
  GH_REPO: ${{ github.event.repository.name }}
jobs:
  get-env:
    runs-on: self-hosted
    steps:
      - run: |
          cd
          echo "$PWD"
          export $(cat /etc/environment)

  build:
    runs-on: self-hosted
    needs: get-env
    steps:
      - uses: actions/checkout@v4
      - uses: oNaiPs/secrets-to-env-action@v1
        with:
          secrets: ${{ toJSON(secrets) }}
      - run: |
          cd ~
          set -a
          export $(cat /etc/environment)
          eval "export $(printf "%s\n" "$MY_SECRETS" | jq -r 'to_entries | map("\(.key)=\(.value)") | @sh')"
          export > $HOME/.work.env

  install:
    runs-on: self-hosted
    needs: build
    steps:
      - run: |
          [ -e $HOME/$GH_REPO ] && rm -r $HOME/$GH_REPO
          cp -r -u ${{ github.workspace }} $HOME/
          rm -r ${{ github.workspace }}

#   deploy:
#     runs-on: self-hosted
#     needs: build

#     steps:
#       # Kill gunicorn server, if running already
#       - name: Kill gunicorn
#         run: pkill gunicorn || true

#       # Run gunicorn server
#       - name: Run gunicorn
#         run: |
#           source flask-env/bin/activate
#           RUNNER_TRACKING_ID=""
#           gunicorn -w 1 -b 0.0.0.0:4000 app:app -D --log-file=gunicorn.log
